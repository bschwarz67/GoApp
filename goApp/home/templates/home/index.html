	{% extends "base.html" %}
	<head>
		<style>
		{% block css %}
			select {
				width: 150px;
			}
		{% endblock %}
		</style>
	</head>
	
	<body>
	{% block content %}
		{% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}


		<div id="create-temp-player-container">
			Enter a name: <input type="text" name="name" pattern="[a-zA-z0-9]*" maxlength="10" id="input-username">
			<input type="submit" value="Create Temporary Player" id="create-temp-player">
		</div>
		


		
		<select id="opponent-select" size="15">
			{% for x in availablePlayers %}
				<option value="{{ x }}">{{ x }}</option>
			{% endfor %}
		</select>
		<input id="opponent-challenge" type="submit" value="Challenge">

		<br>
		<br>

		<select id="invitations" size="15">
			{% for x in challengingPlayers %}
				<option value="{{ x }}" id="{{ x }}">{{ x }}</option>
			{% endfor %}
		</select>
		<input id="opponent-accept" type="submit" value="Accept">

		<br>
		<br>

		<select id="current-games" size="15">
			{% for x in opponentObjects %}
				<option onclick="redirectToBoard(this)" value="{{ x.value }}" id="{{ x.gameId }}">{{ x.value }}</option>
			{% endfor %}
		</select>

		{{ challengingPlayers|json_script:"challengingPlayersList" }}
		<script id="challengingPlayersList"></script>

		{{ challengedPlayers|json_script:"challengedPlayersList" }}
		<script id="challengedPlayersList"></script>

		{{ opponents|json_script:"opponentsList" }}
		<script id="opponentsList"></script>

		{{ ids|json_script:"idsList" }}
		<script id="idsList"></script>

		{{ user.color|json_script:"color" }}
		<script id="color"></script>


		<script>



			{% if user.is_authenticated %}
			console.log("authenticated!");
			var perfEntries = performance.getEntriesByType("navigation");

			if (perfEntries[0].type === "back_forward") {
    			location.reload(true);
			}

			let challengedPlayers = JSON.parse(document.getElementById('challengedPlayersList').textContent);
			let opponents = JSON.parse(document.getElementById('opponentsList').textContent);
			let challengingPlayers = JSON.parse(document.getElementById('challengingPlayersList').textContent);
			

			//pulls player color into javascript
			let playerColor = JSON.parse(document.getElementById('color').textContent);


			const challengeSocket = new WebSocket(
				'ws://'
				+ window.location.host
				+ '/ws/challenge/'
        	);

			function redirectToBoard(event) {
				let gameIdSlug = event.id + "_" + event.value +  "_game/";
				window.location.href= "/board/" + gameIdSlug;
			};


			challengeSocket.onmessage = function(e) {
				const data = JSON.parse(e.data);
				if(data.messageType == 'challenge') {
					var newOption = document.createElement('option');
					newOption.value = data.message;
					newOption.text = data.message;
					newOption.id = data.message;
					document.querySelector('#invitations').add(newOption);
				}
				else if (data.messageType == 'accept') { 
					var newOption = document.createElement('option');
					newOption.value = data.message;
					newOption.text = data.message;
					newOption.id = data.gameId;
					newOption.onclick = function(){redirectToBoard(this)};
					//newOption.onclick = redirectToBoard(e);
					var deletedOption = document.querySelector('#invitations').options.namedItem(data.message);
					if(deletedOption != null) {
						document.querySelector('#invitations').options.remove(deletedOption.index);
					}
					document.querySelector('#current-games').add(newOption);
				}
				else {
					var newOption = document.createElement('option');
					newOption.value = data.message;
					newOption.text = data.message;
					newOption.id = data.message;
					document.querySelector('#opponent-select').add(newOption);
				}
        	};

        	challengeSocket.onclose = function(e) {
            	console.error('Challenge socket closed unexpectedly');
        	};


			document.querySelector('#opponent-challenge').onclick = function(e) {
				console.log("challenging....")

				let challengedPlayers = JSON.parse(document.getElementById('challengedPlayersList').textContent);
				let opponents = JSON.parse(document.getElementById('opponentsList').textContent);
				
				const messageInputDom = document.querySelector('#opponent-select');
				const playerToChallenge = messageInputDom.options[messageInputDom.selectedIndex].value;
				
				
				

				if(!challengedPlayers.includes(playerToChallenge) && !opponents.includes(playerToChallenge)){
					challengedPlayers.push(playerToChallenge);
					document.getElementById('challengedPlayersList').textContent = JSON.stringify(challengedPlayers);
					console.log("send message to socket...")
					challengeSocket.send(JSON.stringify({
						'message': playerToChallenge,
						'messageType': 'challenge'
					}));
					messageInputDom.value = '';
				}

			};

			




			document.querySelector('#create-temp-player').onclick = function(e) {

				let errorNode = document.createElement("div");
				errorNode.style.width = "160px";
				errorNode.style.height = "20px";
				errorNode.textContent = "You have already create a temporary player";
				errorNode.style.color = "red";
				let submitNode = document.querySelector("#create-temp-player")
				document.querySelector("#create-temp-player-container").insertBefore(errorNode, submitNode.nextSibling);
			
				
				window.setTimeout(function() {
					errorNode.parentNode.removeChild(errorNode);
					
				}, 2000);
			
			};



			//TODO write in handler for when no player is selected to accept

        	document.querySelector('#opponent-accept').onclick = function(e) {
        		let opponents = JSON.parse(document.getElementById('opponentsList').textContent);
    			const messageInputDom = document.querySelector('#invitations');
				const playerToAccept = messageInputDom.options[messageInputDom.selectedIndex].value;

				
				opponents.push(playerToAccept);
				document.getElementById('opponentsList').textContent = JSON.stringify(opponents);
				challengeSocket.send(JSON.stringify({
					'message': playerToAccept,
					'messageType': 'accept'

				}));
				messageInputDom.value = '';
        	};

			{% else %}

			var perfEntries = performance.getEntriesByType("navigation");

			if (perfEntries[0].type === "back_forward") {
    			location.reload(true);
			}

			const challengeSocket = new WebSocket(
				'ws://'
				+ window.location.host
				+ '/ws/challenge/'
        	);

			challengeSocket.onmessage = function(e) {
				const data = JSON.parse(e.data);
				if(data.addToPossibleOpponents == 'False') {
					window.location.href= `/home/logNewPlayerIn/${data.message}`;
				
				}
				else {
					var newOption = document.createElement('option');
					newOption.value = data.message;
					newOption.text = data.message;
					newOption.id = data.message;
					document.querySelector('#opponent-select').add(newOption);
				}
				
        	};

			document.querySelector('#create-temp-player').onclick = function(e) {

				const inputUsername = document.querySelector('#input-username').value;

				const filter = /\W/;
				if(!filter.test(inputUsername) && inputUsername.length <= 10) {
					challengeSocket.send(JSON.stringify({
						'possibleNewPlayer': inputUsername,
						'messageType': 'createNewPlayer'
					}));
				}

			};

        	{% endif %}


		</script>



	{% endblock %}
	</body>
