{% extends "base.html" %}

	<head>
		<style>
		{% block css %}
			.piece-container {
				display: grid;
				grid-template-columns: 43px 43px 43px 43px 43px 43px 43px;
				grid-template-rows: 43px 43px 43px 43px 43px 43px 43px;
				width: 500px;
				height: 500px;
			}
			
			.tile-container {
				display: grid;
				grid-template-columns: 40px 40px 40px 40px 40px 40px;
				grid-template-rows: 40px 40px 40px 40px 40px 40px;
				grid-gap: 3px;
				width: 255px;
				height: 255px;
			}

			
			.piece-container input[type="radio"] {
				opacity: 0;
				position: fixed;
				width: 0px;
				height: 0px;
			}
			

			
			.piece-container label {
				border-radius: 50%;
				width: 43px;
				height: 43px;
				display: inline-block;
			}
			
			
			.piece-container input[type="radio"]:checked + label {
				background-color:#bfb;
				border-color: #4c4;
			}
	
			.piece-container div {
				width: 43px;
				height: 43px;
				z-index: 2;
			}

			.tile-container div {
				width: 40px;
				height: 40px;
				position: relative;
				background-color: #884029;
				top: -478px;
				left: 22px;
				z-index: 1;
			}

			#submit-container {
				width: 80px;
				height: 40px;
			}


			#Play {
				width: 80px;
				height: 20px;
			}

		{% endblock %}
		</style>
	</head>
	<body>
	{% block content %}
		{% load boardExtras %}
		<form class="piece-container">
		{% csrf_token %}
			{% for x in game.piecePositions|split %}
				
				<div>	
					<input type="radio" name="coordinate" value="{{ forloop.counter }}" id="coordinate_{{ forloop.counter }}">
					<label for="coordinate_{{ forloop.counter }}" id="coordinate_{{ forloop.counter }}"></label>
				</div>

			{% endfor %}
			<div id="submit-container">
				<div id="submit-error"></div>
				<input type="button" value="Play" id="Play">
			</div>
			
		</form>
		
		<div class="tile-container">
			{% for x in 36|numberRange %}

				<div>	
				</div>

			{% endfor %}
		</div>



		<h1>{{ request.path }}</h1>


		{{ game|json_script:"viewsGame" }}
		<script id="viewsGame"></script>

		
		
		<script>

			const playSocket = new WebSocket(
				'ws://'
				+ window.location.host
				+ '/ws/play/'
			);

			//pulls game into javascript
			let game = JSON.parse(document.getElementById('viewsGame').textContent);

			


			playSocket.onmessage = function(e) {
				const data = JSON.parse(e.data);
				if(data.messageType == 'playedAgainstOpponent') {

					let playedLabel = document.querySelector(`label[for=coordinate_${data.coordinatePlayed}]`);
					playedLabel.style.backgroundColor = "#bfb";
					playedLabel.style.borderColor = "#4c4";

				}

				else if(data.messageType == 'played') {

					let playedLabel = document.querySelector(`label[for=coordinate_${data.coordinatePlayed}]`);
					playedLabel.style.backgroundColor = "#bfb";
					playedLabel.style.borderColor = "#4c4";

				}


				else {

					let errorNode = document.createElement("div");
					errorNode.style.width = "160px";
					errorNode.style.height = "20px";
					errorNode.textContent = "sorry thats an invalid move";
					errorNode.style.color = "red";
					document.querySelector("#submit-container").insertBefore(errorNode, document.querySelector("#Play"));
				
					
					window.setTimeout(function() {
      					errorNode.parentNode.removeChild(errorNode);
      					
    				}, 2000);

				}
			};

			playSocket.onclose = function(e) {
				console.error('Chat socket closed unexpectedly');

			}	


			document.querySelector("#Play").onclick = function(e) {
				let playedInput = document.querySelector('input[name="coordinate"]:checked');
				let playedLabel = document.querySelector(`label[for=${playedInput.id}]`);
				
				



				if(game.whitePlayer == game.playerInScope) {
					playSocket.send(JSON.stringify({
					'playedAgainst': game.blackPlayer,
					'messageType': 'play',
					'coordinate': playedLabel.id.split("_")[1],
					'gameID': game.id

					}));
				}
				else {
					playSocket.send(JSON.stringify({
					'playedAgainst': game.whitePlayer,
					'messageType': 'play',
					'coordinate': playedLabel.id.split("_")[1],
					'gameID': game.id

					}));
				}

				

        	};

		</script>
	
	{% endblock %}
	</body>