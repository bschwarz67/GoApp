{% extends "base.html" %}

	<head>
		<style>
		{% block css %}
			.piece-container {
				display: grid;
				grid-template-columns: 43px 43px 43px 43px 43px 43px 43px;
				grid-template-rows: 43px 43px 43px 43px 43px 43px 43px;
				width: 500px;
				height: 500px;
			}
			
			.tile-container {
				display: grid;
				grid-template-columns: 40px 40px 40px 40px 40px 40px;
				grid-template-rows: 40px 40px 40px 40px 40px 40px;
				grid-gap: 3px;
				width: 255px;
				height: 255px;
			}

			
			.piece-container input[type="radio"] {
				opacity: 0;
				position: fixed;
				width: 0px;
				height: 0px;
			}
			

			
			.piece-container label {
				border-radius: 50%;
				width: 43px;
				height: 43px;
				display: inline-block;
			}
			
			
			.piece-container input[type="radio"]:checked + label {
				background-color:#bfb;
				border-color: #4c4;
			}
	
			.piece-container div {
				width: 43px;
				height: 43px;
				z-index: 2;
			}

			.tile-container div {
				width: 40px;
				height: 40px;
				position: relative;
				background-color: #884029;
				top: -478px;
				left: 22px;
				z-index: 1;
			}

			#submit-container {
				width: 80px;
				height: 40px;
			}


			#Play {
				width: 80px;
				height: 20px;
			}

		{% endblock %}
		</style>
	</head>
	<body>
	{% block content %}
		{% load boardExtras %}
		<form class="piece-container">
		{% csrf_token %}
			{% for x in game.piecePositions|split %}
				
				{% if x == "1" %}
					<div>	
						<input type="radio" name="coordinate" value="{{ forloop.counter0 }}" id="coordinate_{{ forloop.counter0 }}">
						<label style="background-color:grey;border-color:grey"for="coordinate_{{ forloop.counter0 }}" id="coordinate_{{ forloop.counter0 }}"></label>
					</div>
				{% elif x == "2" %}
				<div>	
					<input type="radio" name="coordinate" value="{{ forloop.counter0 }}" id="coordinate_{{ forloop.counter0 }}">
					<label style="background-color:black;border-color:black"for="coordinate_{{ forloop.counter0 }}" id="coordinate_{{ forloop.counter0 }}"></label>
				</div>
				{% else %}
					<div>	
						<input type="radio" name="coordinate" value="{{ forloop.counter0 }}" id="coordinate_{{ forloop.counter0 }}">
						<label for="coordinate_{{ forloop.counter0 }}" id="coordinate_{{ forloop.counter0 }}"></label>
					</div>
				{% endif %}

			{% endfor %}
			<div id="submit-container">
				<div id="submit-error"></div>
				<input type="button" value="Play" id="Play">
			</div>
			
		</form>
		
		<div class="tile-container">
			{% for x in 36|numberRange %}

				<div>	
				</div>

			{% endfor %}
		</div>



		<h1>{{ request.path }}</h1>


		{{ game|json_script:"viewsGame" }}
		<script id="viewsGame"></script>

		
		
		<script>
			//pulls game into javascript
			let game = JSON.parse(document.getElementById('viewsGame').textContent);

			const playSocket = new WebSocket(
				'ws://'
				+ window.location.host
				+ `/ws/play/${game.id}/`
			);

			

			


			playSocket.onmessage = function(e) {
				const data = JSON.parse(e.data);
				
				if(data.message_type == 'played_against_opponent') {
					
					let coordinatesTaken = data.coordinates_taken.split(/\[|\]|,\s/)
					console.log(coordinatesTaken)
					if(data.played_against == game.whitePlayer) {
						let playedLabel = document.querySelector(`label[for=coordinate_${data.coordinate_played}]`);
						playedLabel.style.backgroundColor = "black";
						playedLabel.style.borderColor = "black";
						for(x = 1; x < coordinatesTaken.length - 1; x++) {
							console.log(x)
							if(coordinatesTaken[x] != "") {
								let takenLabel = document.querySelector(`label[for=coordinate_${coordinatesTaken[x]}]`);
								takenLabel.style.backgroundColor = "transparent";
								takenLabel.style.borderColor = "transparent";
							}
						}
					}
					else {
						let playedLabel = document.querySelector(`label[for=coordinate_${data.coordinate_played}]`);
						playedLabel.style.backgroundColor = "grey";
						playedLabel.style.borderColor = "grey";
						for(x = 1; x < coordinatesTaken.length - 1; x++) {
							console.log(x)
							if(coordinatesTaken[x] != "") {
								let takenLabel = document.querySelector(`label[for=coordinate_${coordinatesTaken[x]}]`);
								takenLabel.style.backgroundColor = "transparent";
								takenLabel.style.borderColor = "transparent";
							}
						}
					}

				}

				else if(data.message_type == 'played') {

					let coordinatesTaken = data.coordinates_taken.split(/\[|\]|,\s/)
					console.log(coordinatesTaken)
					if(data.played_against == game.whitePlayer) {
						let playedLabel = document.querySelector(`label[for=coordinate_${data.coordinate_played}]`);
						playedLabel.style.backgroundColor = "black";
						playedLabel.style.borderColor = "black";
						for(x = 1; x < coordinatesTaken.length - 1; x++) {
							console.log(x)
							if(coordinatesTaken[x] != "") {
								let takenLabel = document.querySelector(`label[for=coordinate_${coordinatesTaken[x]}]`);
								takenLabel.style.backgroundColor = "transparent";
								takenLabel.style.borderColor = "transparent";
							}
						}
					}
					else {
						let playedLabel = document.querySelector(`label[for=coordinate_${data.coordinate_played}]`);
						playedLabel.style.backgroundColor = "grey";
						playedLabel.style.borderColor = "grey";
						for(x = 1; x < coordinatesTaken.length - 1; x++) {
							console.log(x)
							if(coordinatesTaken[x] != "") {
								let takenLabel = document.querySelector(`label[for=coordinate_${coordinatesTaken[x]}]`);
								takenLabel.style.backgroundColor = "transparent";
								takenLabel.style.borderColor = "transparent";
							}
						}
					}
					

				}


				else {

					let errorNode = document.createElement("div");
					errorNode.style.width = "160px";
					errorNode.style.height = "20px";
					errorNode.textContent = data.message;
					errorNode.style.color = "red";
					document.querySelector("#submit-container").insertBefore(errorNode, document.querySelector("#Play"));
				
					
					window.setTimeout(function() {
      					errorNode.parentNode.removeChild(errorNode);
      					
    				}, 2000);

				}
			};

			playSocket.onclose = function(e) {
				console.error('Chat socket closed unexpectedly');

			}	


			document.querySelector("#Play").onclick = function(e) {
				let playedInput = document.querySelector('input[name="coordinate"]:checked');
				let playedLabel = document.querySelector(`label[for=${playedInput.id}]`);
				
				


				if(game.whitePlayer == game.playerInScope) {
					playSocket.send(JSON.stringify({
					'playedAgainst': game.blackPlayer,
					'messageType': 'play',
					'coordinate': playedLabel.id.split("_")[1],
					'gameID': game.id

					}));
				}
				else {
					playSocket.send(JSON.stringify({
					'playedAgainst': game.whitePlayer,
					'messageType': 'play',
					'coordinate': playedLabel.id.split("_")[1],
					'gameID': game.id

					}));
				}

				

        	};

		</script>
	
	{% endblock %}
	</body>